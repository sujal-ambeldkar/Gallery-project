<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard - Media & Notes</title>
<link rel="stylesheet" href="style.css">
<style>
/* ----------------- Dashboard Header ----------------- */
.dashboard-header {
  position: relative;
  background: linear-gradient(to right, #4f46e5, #6366f1);
  color: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  margin-bottom: 30px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
}
.dashboard-header h2 { font-size: 28px; margin-bottom: 5px; }
.dashboard-header p { font-size: 16px; color: #e0e7ff; }
#logoutBtn {
  position: absolute; top: 20px; right: 20px;
  background: #e11d48; color: white; border: none;
  padding: 10px 18px; border-radius: 8px;
  cursor: pointer; font-weight: 500; transition: 0.3s;
}
#logoutBtn:hover { background: #be123c; transform: translateY(-2px); }

/* ----------------- Tabs ----------------- */
.tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
.tabs button {
  background: #e0e7ff; color: #4f46e5; border: none;
  padding: 10px 20px; border-radius: 8px; cursor: pointer;
  font-weight: 500; transition: 0.3s;
}
.tabs button.active, .tabs button:hover { background: #4f46e5; color: white; transform: translateY(-2px); }

/* ----------------- Admin Form Cards ----------------- */
.admin-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px; margin-bottom: 30px;
}
.card form { display: flex; flex-direction: column; gap: 12px; }
.card form input, .card form textarea, .card form button { width: 100%; }

/* ----------------- Gallery & Notes Section ----------------- */
.gallery, #notesContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }

/* ----------------- Card Styling ----------------- */
.card {
  background: white; padding: 20px; border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  display: flex; flex-direction: column; justify-content: flex-start;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
.card h4, .card h3 { margin-bottom: 10px; color: #4f46e5; }
.card p { margin-bottom: 10px; color: #555; }

/* Media Styling */
img, video, audio { width: 100%; border-radius: 8px; margin-bottom: 10px; }

/* Delete Button */
button.delete {
  background: #e11d48; color: white; border: none;
  padding: 8px 14px; border-radius: 6px; cursor: pointer;
  font-size: 14px; transition: 0.3s; align-self: flex-start;
}
button.delete:hover { background: #be123c; transform: translateY(-2px); }

/* Location Card */
.location-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 5px; background: #f7f7f7; }

/* Responsive */
@media(max-width:600px){ .tabs { flex-direction: column; gap: 12px; } }
</style>
</head>
<body>
<div class="container">

<!-- Dashboard Header -->
<div class="dashboard-header">
  <h2 id="welcomeUser">Welcome!</h2>
  <p id="userRoleDisplay">Role: </p>
  <button id="logoutBtn">Logout</button>
</div>

<button id="locationBtn">üìç Save My Location</button>
<p id="locationStatus"></p>

<!-- Admin Form Cards -->
<div class="admin-cards">
  <div class="card" id="uploadCard" style="display:none;">
    <h3>Upload Media (Admin Only)</h3>
    <form id="uploadForm">
      <input type="file" id="file" required />
      <button type="submit">Upload</button>
    </form>
  </div>
  <div class="card" id="noteCard" style="display:none;">
    <h3>Add Note (Admin Only)</h3>
    <form id="noteForm">
      <input type="text" id="noteTitle" placeholder="Note Title" required />
      <textarea id="noteContent" placeholder="Note Content" rows="3" required></textarea>
      <button type="submit">Add Note</button>
    </form>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button id="galleryTab" class="active">Gallery</button>
  <button id="notesTab">Notes</button>
</div>

<!-- Sections -->
<div id="gallerySection">
  <h3>Gallery</h3>
  <div class="gallery" id="gallery"></div>
</div>

<div id="notesSection">
  <h3>Notes</h3>
  <div id="notesContainer"></div>
</div>

<!-- Location Cards -->
<h3>Locations</h3>
<div id="locationsContainer"></div>

</div>

<script>
// ------------------ User Info ------------------
let token = localStorage.getItem("token");
let userRole = localStorage.getItem("role");
let username = localStorage.getItem("username") || "User";
if(!token) window.location.href = "login.html";

document.getElementById("welcomeUser").innerText = `Welcome, ${username}!`;
document.getElementById("userRoleDisplay").innerText = `Role: ${userRole}`;

// Show admin cards
if(userRole==="admin"){
  document.getElementById("uploadCard").style.display = "block";
  document.getElementById("noteCard").style.display = "block";
}

// Logout
document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.clear();
  window.location.href = "login.html";
};

// ------------------ Save Location ------------------
document.getElementById("locationBtn").addEventListener("click", () => {
  if (!navigator.geolocation) { alert("Geolocation not supported"); return; }

  navigator.geolocation.getCurrentPosition(async (position) => {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    try {
      const res = await fetch("http://localhost:5000/api/location/save", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({ lat, lng })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.msg || "Failed to save location");
      }

      document.getElementById("locationStatus").innerText = "‚úÖ Location saved";
      loadLocations(); // <-- refresh locations immediately
    } catch (err) {
      console.error(err);
      alert("Failed to save location");
    }
  }, () => alert("Permission denied"));
});

// ------------------ Display Locations ------------------
async function loadLocations() {
  const container = document.getElementById("locationsContainer");
  container.innerHTML = "";
  try {
    const res = await fetch("http://localhost:5000/api/location/all");
    const locations = await res.json();
    locations.forEach(loc => {
      const date = new Date(loc.createdAt);
      const div = document.createElement("div");
      div.className = "location-card";
      div.innerHTML = `
        <p>User: ${loc.user.username}</p>
        <p>Lat: ${loc.lat}, Lng: ${loc.lng}</p>
        <p>Time: ${date.toLocaleString()}</p>
      `;
      container.appendChild(div);
    });
  } catch (err) { console.error("Failed to load locations:", err); }
}
loadLocations();

// ------------------ Tabs ------------------
const galleryTab = document.getElementById("galleryTab");
const notesTab = document.getElementById("notesTab");
const gallerySection = document.getElementById("gallerySection");
const notesSection = document.getElementById("notesSection");

gallerySection.style.display="block";
notesSection.style.display="none";
galleryTab.classList.add("active");
notesTab.classList.remove("active");

galleryTab.onclick = ()=>{
  gallerySection.style.display="block"; notesSection.style.display="none";
  galleryTab.classList.add("active"); notesTab.classList.remove("active");
}
notesTab.onclick = ()=>{
  gallerySection.style.display="none"; notesSection.style.display="block";
  notesTab.classList.add("active"); galleryTab.classList.remove("active");
}

// ------------------ Media & Notes Logic ------------------
const gallery = document.getElementById("gallery");
const notesContainer = document.getElementById("notesContainer");

uploadForm.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!token) return alert("Login as admin to upload");
  const fileInput = document.getElementById("file");
  if(!fileInput.files[0]) return alert("Select a file");
  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  try {
    await fetch("http://localhost:5000/api/media/upload",{
      method:"POST", headers:{Authorization:"Bearer "+token}, body:formData
    });
    fileInput.value="";
    loadMedia();
  } catch(err){console.error(err);}
});

noteForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const title = document.getElementById("noteTitle").value;
  const content = document.getElementById("noteContent").value;
  if(!title || !content) return alert("Fill all fields");
  try{
    await fetch("http://localhost:5000/api/notes/create",{
      method:"POST", headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
      body: JSON.stringify({title, content})
    });
    noteForm.reset();
    loadNotes();
  } catch(err){console.error(err);}
});

// ------------------ Load Media ------------------
async function loadMedia(){
  gallery.innerHTML="";
  try{
    const res = await fetch("http://localhost:5000/api/media/all");
    const mediaList = await res.json();
    mediaList.forEach(media=>{
      const card = document.createElement("div");
      card.className="card";
      const url = media.url;
      let type="image";
      if(url.match(/\.(mp4|mov|avi|webm)$/i)) type="video";
      else if(url.match(/\.(mp3|wav|ogg)$/i)) type="audio";
      if(type==="image") card.innerHTML=`<img src="${url}" />`;
      else if(type==="video") card.innerHTML=`<video controls src="${url}"></video>`;
      else card.innerHTML=`<audio controls src="${url}"></audio>`;
      if(userRole==="admin"){
        const btn = document.createElement("button");
        btn.textContent="Delete"; btn.className="delete";
        btn.onclick = async ()=>{
          if(!confirm("Delete this media?")) return;
          try{
            await fetch("http://localhost:5000/api/media/delete",{method:"DELETE", headers:{"Content-Type":"application/json","Authorization":"Bearer "+token}, body:JSON.stringify({url})});
            loadMedia();
          } catch(err){console.error(err);}
        };
        card.appendChild(btn);
      }
      gallery.appendChild(card);
    });
  } catch(err){console.error(err);}
}

// ------------------ Load Notes ------------------
async function loadNotes(){
  notesContainer.innerHTML="";
  try{
    const res = await fetch("http://localhost:5000/api/notes/all");
    const notes = await res.json();
    notes.forEach(note=>{
      const div = document.createElement("div");
      div.className="card"; div.style.padding="10px";
      div.innerHTML=`<h4>${note.title}</h4><p>${note.content}</p>`;
      if(userRole==="admin"){
        const btn = document.createElement("button");
        btn.textContent="Delete"; btn.className="delete";
        btn.onclick=async()=>{
          if(!confirm("Delete this note?")) return;
          await fetch(`http://localhost:5000/api/notes/delete/${note._id}`,{method:"DELETE", headers:{Authorization:"Bearer "+token}});
          loadNotes();
        };
        div.appendChild(btn);
      }
      notesContainer.appendChild(div);
    });
  } catch(err){console.error(err);}
}

// ------------------ Initialize ------------------
loadMedia();
loadNotes();
</script>
</body>
</html>
