<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Media & Notes</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 15px;
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

/* ----------------- Dashboard Header ----------------- */
.dashboard-header {
  background: linear-gradient(135deg, #4f46e5, #6366f1);
  color: white;
  padding: 25px;
  border-radius: 20px;
  text-align: center;
  margin-bottom: 30px;
  box-shadow: 0 20px 40px rgba(79, 70, 229, 0.3);
  position: relative;
  overflow: hidden;
}

.dashboard-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.1);
  transform: rotate(30deg);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
}

.dashboard-header h2 { 
  font-size: clamp(1.5rem, 4vw, 2.2rem); 
  margin-bottom: 8px;
  font-weight: 700;
}

.dashboard-header p { 
  font-size: clamp(0.9rem, 2.5vw, 1.1rem); 
  color: #e0e7ff;
  opacity: 0.9;
}

#logoutBtn {
  position: absolute; 
  top: 20px; 
  right: 20px;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  color: white; 
  border: 1px solid rgba(255,255,255,0.3);
  padding: 12px 20px; 
  border-radius: 50px;
  cursor: pointer; 
  font-weight: 600; 
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

#logoutBtn:hover { 
  background: rgba(225, 29, 72, 0.9);
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 10px 25px rgba(225, 29, 72, 0.4);
}

/* ----------------- Location Button ----------------- */
#locationBtn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  padding: 14px 24px;
  border-radius: 50px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

#locationBtn:hover {
  background: rgba(34, 197, 94, 0.9);
  transform: translateY(-3px);
  box-shadow: 0 15px 30px rgba(34, 197, 94, 0.4);
}

#locationStatus {
  color: #10b981;
  font-weight: 500;
  margin-bottom: 25px;
  font-size: 0.95rem;
}

/* ----------------- Admin Cards ----------------- */
.admin-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  padding: 25px;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.card:hover {
  transform: translateY(-10px) scale(1.02);
  box-shadow: 0 30px 60px rgba(0,0,0,0.15);
}

.card h3, .card h4 {
  color: #4f46e5;
  margin-bottom: 15px;
  font-size: 1.3rem;
  font-weight: 700;
}

.card form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.card input, .card textarea, .card button {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: rgba(255,255,255,0.8);
}

.card input:focus, .card textarea:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.card textarea { resize: vertical; min-height: 100px; }

/* ----------------- Tabs ----------------- */
.tabs {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.tabs button {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  padding: 14px 28px;
  border-radius: 50px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.tabs button.active, .tabs button:hover {
  background: linear-gradient(135deg, #4f46e5, #6366f1);
  transform: translateY(-3px);
  box-shadow: 0 15px 30px rgba(79, 70, 229, 0.4);
}

/* ----------------- Gallery & Notes ----------------- */
.gallery, #notesContainer {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

#gallerySection h3, #notesSection h3, h3 {
  color: white;
  font-size: clamp(1.4rem, 3vw, 1.8rem);
  margin-bottom: 25px;
  text-align: center;
  font-weight: 700;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

/* Media Styling */
img, video, audio {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 16px;
  margin-bottom: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

audio { height: auto; }

/* Delete Button */
button.delete {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.3s ease;
  align-self: flex-start;
  box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
}

button.delete:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 10px 25px rgba(239, 68, 68, 0.6);
}

/* Location Cards */
.location-card {
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.3);
  padding: 20px;
  margin-bottom: 15px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.location-card p {
  margin-bottom: 8px;
  color: #374151;
  font-size: 0.95rem;
}

/* ----------------- Responsive Design ----------------- */
@media (max-width: 768px) {
  body { padding: 10px; }
  
  .dashboard-header {
    padding: 20px 15px;
    margin-bottom: 20px;
  }
  
  #logoutBtn {
    position: static;
    margin-top: 15px;
    width: 100%;
  }
  
  .tabs {
    flex-direction: column;
    align-items: center;
  }
  
  .tabs button {
    width: 100%;
    max-width: 300px;
    padding: 16px 24px;
  }
  
  .admin-cards {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .gallery, #notesContainer {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
  }
  
  #locationBtn {
    width: 100%;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .gallery, #notesContainer {
    grid-template-columns: 1fr;
  }
  
  .card {
    padding: 20px 15px;
  }
  
  img, video {
    height: 180px;
  }
}

/* Loading Animation */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div class="container">

<!-- Dashboard Header -->
<div class="dashboard-header">
  <h2 id="welcomeUser">Welcome!</h2>
  <p id="userRoleDisplay">Role: </p>
  <button id="logoutBtn">Logout</button>
</div>

<button id="locationBtn">üìç Save My Location</button>
<p id="locationStatus"></p>

<!-- Admin Form Cards -->
<div class="admin-cards">
  <div class="card" id="uploadCard" style="display:none;">
    <h3>Upload Media (Admin Only)</h3>
    <form id="uploadForm">
      <input type="file" id="file" required />
      <button type="submit">Upload Media</button>
    </form>
  </div>
  <div class="card" id="noteCard" style="display:none;">
    <h3>Add Note (Admin Only)</h3>
    <form id="noteForm">
      <input type="text" id="noteTitle" placeholder="Note Title" required />
      <textarea id="noteContent" placeholder="Note Content" rows="3" required></textarea>
      <button type="submit">Add Note</button>
    </form>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button id="galleryTab" class="active">üì∏ Gallery</button>
  <button id="notesTab">üìù Notes</button>
</div>

<!-- Sections -->
<div id="gallerySection">
  <h3>Media Gallery</h3>
  <div class="gallery" id="gallery"></div>
</div>

<div id="notesSection" style="display:none;">
  <h3>Notes</h3>
  <div id="notesContainer"></div>
</div>

<!-- Location Cards -->
<h3>üìç Recent Locations</h3>
<div id="locationsContainer"></div>

</div>

<script>
// ------------------ Config ------------------
const API_BASE = "https://gallery-project-backend-production.up.railway.app";

// ------------------ User Info ------------------
let token = localStorage.getItem("token");
let userRole = localStorage.getItem("role");
let username = localStorage.getItem("username") || "User";

if (!token) window.location.href = "login.html";

document.getElementById("welcomeUser").innerText = `Welcome, ${username}!`;
document.getElementById("userRoleDisplay").innerText =
  `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;

// Show admin cards
if (userRole === "admin") {
  document.getElementById("uploadCard").style.display = "block";
  document.getElementById("noteCard").style.display = "block";
}

// Logout
document.getElementById("logoutBtn").onclick = () => {
  localStorage.clear();
  window.location.href = "login.html";
};

// ------------------ Save Location ------------------
const locationBtn = document.getElementById("locationBtn");
const locationStatus = document.getElementById("locationStatus");

document.getElementById("locationBtn").addEventListener("click", async () => {
  locationBtn.innerHTML = '<span class="loading"></span> Saving...';
  locationBtn.disabled = true;
  
  if (!navigator.geolocation) { 
    alert("Geolocation not supported"); 
    resetLocationBtn();
    return; 
  }

  navigator.geolocation.getCurrentPosition(async (position) => {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    try {
      const res = await fetch(`${API_BASE}/api/location/save`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ lat, lng })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.msg || "Failed to save location");
      }

      locationStatus.innerText = "‚úÖ Location saved successfully!";
      loadLocations();
    } catch (err) {
      console.error(err);
      alert("Failed to save location: " + err.message);
    } finally {
      resetLocationBtn();
    }
  }, () => {
    alert("Location access denied");
    resetLocationBtn();
  });
});

function resetLocationBtn() {
  setTimeout(() => {
    locationBtn.innerHTML = 'üìç Save My Location';
    locationBtn.disabled = false;
  }, 1500);
}

// ------------------ Display Locations ------------------
async function loadLocations() {
  const container = document.getElementById("locationsContainer");
  container.innerHTML =
    '<div style="text-align:center;padding:40px;color:#9ca3af;">Loading locations...</div>';
  
  try {
    const res = await fetch(`${API_BASE}/api/location/all`);
    const locations = await res.json();
    
    container.innerHTML = "";
    if (locations.length === 0) {
      container.innerHTML =
        '<div style="text-align:center;padding:40px;color:#9ca3af;">No locations saved yet</div>';
      return;
    }
    
    locations.forEach(loc => {
      const date = new Date(loc.createdAt);
      const div = document.createElement("div");
      div.className = "location-card";
      div.innerHTML = `
        <p><strong>üë§ ${loc.user.username}</strong></p>
        <p>üìç ${loc.lat.toFixed(6)}, ${loc.lng.toFixed(6)}</p>
        <p>üïí ${date.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}</p>
      `;
      container.appendChild(div);
    });
  } catch (err) { 
    console.error("Failed to load locations:", err);
    container.innerHTML =
      '<div style="text-align:center;padding:40px;color:#ef4444;">Failed to load locations</div>';
  }
}
loadLocations();

// ------------------ Tabs ------------------
const galleryTab = document.getElementById("galleryTab");
const notesTab = document.getElementById("notesTab");
const gallerySection = document.getElementById("gallerySection");
const notesSection = document.getElementById("notesSection");

gallerySection.style.display = "block";
notesSection.style.display = "none";

galleryTab.onclick = () => {
  gallerySection.style.display = "block"; 
  notesSection.style.display = "none";
  galleryTab.classList.add("active"); 
  notesTab.classList.remove("active");
  loadMedia();
}

notesTab.onclick = () => {
  gallerySection.style.display = "none"; 
  notesSection.style.display = "block";
  notesTab.classList.add("active"); 
  galleryTab.classList.remove("active");
  loadNotes();
}

// ------------------ Media & Notes Logic ------------------
const gallery = document.getElementById("gallery");
const notesContainer = document.getElementById("notesContainer");
const uploadForm = document.getElementById("uploadForm");
const noteForm = document.getElementById("noteForm");

uploadForm.addEventListener("submit", async e => {
  e.preventDefault();
  if (!token) return alert("Login as admin to upload");
  
  const fileInput = document.getElementById("file");
  if (!fileInput.files[0]) return alert("Select a file");
  
  const submitBtn = uploadForm.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerText;
  submitBtn.innerHTML = '<span class="loading"></span> Uploading...';
  submitBtn.disabled = true;
  
  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  
  try {
    await fetch(`${API_BASE}/api/media/upload`, {
      method: "POST", 
      headers: { Authorization: "Bearer " + token }, 
      body: formData
    });
    fileInput.value = "";
    loadMedia();
    alert("Media uploaded successfully!");
  } catch (err) {
    console.error(err);
    alert("Upload failed!");
  } finally {
    submitBtn.innerText = originalText;
    submitBtn.disabled = false;
  }
});

noteForm.addEventListener("submit", async e => {
  e.preventDefault();
  const title = document.getElementById("noteTitle").value;
  const content = document.getElementById("noteContent").value;
  
  if (!title || !content) return alert("Please fill all fields");
  
  const submitBtn = noteForm.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerText;
  submitBtn.innerHTML = '<span class="loading"></span> Adding...';
  submitBtn.disabled = true;
  
  try {
    await fetch(`${API_BASE}/api/notes/create`, {
      method: "POST", 
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ title, content })
    });
    noteForm.reset();
    loadNotes();
    alert("Note added successfully!");
  } catch (err) {
    console.error(err);
    alert("Failed to add note!");
  } finally {
    submitBtn.innerText = originalText;
    submitBtn.disabled = false;
  }
});

// ------------------ Load Media ------------------
async function loadMedia() {
  gallery.innerHTML =
    '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#9ca3af;">Loading media...</div>';
  
  try {
    const res = await fetch(`${API_BASE}/api/media/all`);
    const mediaList = await res.json();
    
    gallery.innerHTML = "";
    if (mediaList.length === 0) {
      gallery.innerHTML =
        '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#9ca3af;">No media available</div>';
      return;
    }
    
    mediaList.forEach(media => {
      const card = document.createElement("div");
      card.className = "card";
      const url = media.url;
      let type = "image";
      
      if (url.match(/\.(mp4|mov|avi|webm)$/i)) type = "video";
      else if (url.match(/\.(mp3|wav|ogg)$/i)) type = "audio";
      
      if (type === "image") {
        card.innerHTML = `<img src="${url}" alt="Media" loading="lazy" />`;
      } else if (type === "video") {
        card.innerHTML =
          `<video controls preload="metadata"><source src="${url}" type="video/${url.split('.').pop()}"></video>`;
      } else {
        card.innerHTML =
          `<audio controls preload="metadata"><source src="${url}" type="audio/${url.split('.').pop()}"></audio>`;
      }
      
      if (userRole === "admin") {
        const btn = document.createElement("button");
        btn.textContent = "üóëÔ∏è Delete";
        btn.className = "delete";
        btn.onclick = async () => {
          if (!confirm("Delete this media?")) return;
          try {
            await fetch(`${API_BASE}/api/media/delete`, {
              method: "DELETE", 
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
              }, 
              body: JSON.stringify({ url })
            });
            loadMedia();
          } catch (err) {
            console.error(err);
            alert("Delete failed!");
          }
        };
        card.appendChild(btn);
      }
      gallery.appendChild(card);
    });
  } catch (err) {
    console.error(err);
    gallery.innerHTML =
      '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ef4444;">Failed to load media</div>';
  }
}

// ------------------ Load Notes ------------------
async function loadNotes() {
  notesContainer.innerHTML =
    '<div style="text-align:center;padding:40px;color:#9ca3af;">Loading notes...</div>';
  
  try {
    const res = await fetch(`${API_BASE}/api/notes/all`);
    const notes = await res.json();
    
    notesContainer.innerHTML = "";
    if (notes.length === 0) {
      notesContainer.innerHTML =
        '<div style="text-align:center;padding:40px;color:#9ca3af;">No notes available</div>';
      return;
    }
    
    notes.forEach(note => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h4>${note.title}</h4>
        <p style="color:#6b7280;">${note.content}</p>
      `;
      
      if (userRole === "admin") {
        const btn = document.createElement("button");
        btn.textContent = "üóëÔ∏è Delete";
        btn.className = "delete";
        btn.onclick = async () => {
          if (!confirm("Delete this note?")) return;
          try {
            await fetch(`${API_BASE}/api/notes/delete/${note._id}`, {
              method: "DELETE", 
              headers: { Authorization: "Bearer " + token }
            });
            loadNotes();
          } catch (err) {
            console.error(err);
            alert("Delete failed!");
          }
        };
        div.appendChild(btn);
      }
      notesContainer.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    notesContainer.innerHTML =
      '<div style="text-align:center;padding:40px;color:#ef4444;">Failed to load notes</div>';
  }
}

// ------------------ Initialize ------------------
loadMedia();
loadNotes();
</script>
</body>
</html>
